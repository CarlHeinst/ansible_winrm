---
  - name: Create Registry Keys
    hosts: Win
    #vars_files:
      #- host_vars/default.yml
    gather_facts: False
    tasks:
    - name: Get Registry Key Value
      script: winRMreg.ps1
      register: WINRM
    - set_fact:
        reg: "{{WINRM.stdout|from_json}}"
    - debug: var=reg
    - name: Set Registry Key for WINRM Idle Time Out   
      win_regedit:
        key: "{{item.key}}"
        value: "{{item.value}}" 
        data: "{{item.data}}" 
        datatype: "{{item.datatype}}"
      with_items:
        - {key: 'HKLM:\Software\Policies\Microsoft\Windows\WinRM\Service\WinRS', value: "MaxShellsPerUser",  data: "10", datatype: "dword"}
        - {key: 'HKLM:\Software\Policies\Microsoft\Windows\WinRM\Service\WinRS', value: "MaxProcessesPerShell", data: "10", datatype: "dword"}
        - {key: 'HKLM:\Software\Policies\Microsoft\Windows\WinRM\Service\WinRS', value: "IdleTimeout", data: "36000000", datatype: "dword"}
      when: reg.IdleTimeout != 36000000 or reg.MaxShellsPerUser != 10 or reg.MaxProcessesPerShell != 10  
